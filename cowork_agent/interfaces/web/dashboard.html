<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cowork Agent</title>
<style>
:root {
  --bg: #ffffff; --bg-secondary: #f5f5f5; --bg-tertiary: #e8e8e8;
  --text: #1a1a1a; --text-secondary: #666666;
  --accent: #2563eb; --accent-light: #dbeafe;
  --success: #16a34a; --error: #dc2626; --warning: #d97706;
  --border: #e0e0e0; --shadow: rgba(0,0,0,0.08);
  --radius: 8px; --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --mono: "SF Mono", "Fira Code", "Cascadia Code", monospace;
}
[data-theme="dark"] {
  --bg: #1a1a2e; --bg-secondary: #16213e; --bg-tertiary: #0f3460;
  --text: #e0e0e0; --text-secondary: #a0a0a0;
  --accent: #4f8cff; --accent-light: #1e3a5f;
  --success: #22c55e; --error: #ef4444; --warning: #f59e0b;
  --border: #2a2a4a; --shadow: rgba(0,0,0,0.3);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: var(--font); background: var(--bg); color: var(--text);
  display: grid; grid-template-columns: 260px 1fr; height: 100vh;
}

/* ── Sidebar ─────────────────────────────────────────── */
.sidebar {
  background: var(--bg-secondary); border-right: 1px solid var(--border);
  display: flex; flex-direction: column; padding: 16px;
}
.sidebar h2 { font-size: 18px; margin-bottom: 12px; color: var(--accent); }
.sidebar-section { margin-bottom: 20px; }
.sidebar-section h3 { font-size: 13px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px; letter-spacing: 0.5px; }
.session-list { list-style: none; }
.session-item {
  padding: 8px 12px; border-radius: var(--radius); cursor: pointer;
  font-size: 13px; margin-bottom: 4px; transition: background 0.15s;
}
.session-item:hover { background: var(--bg-tertiary); }
.session-item.active { background: var(--accent-light); color: var(--accent); font-weight: 600; }
.btn {
  padding: 8px 16px; border: none; border-radius: var(--radius);
  font-size: 13px; cursor: pointer; transition: all 0.15s;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { opacity: 0.9; }
.btn-secondary { background: var(--bg-tertiary); color: var(--text); }
.btn-sm { padding: 4px 10px; font-size: 12px; }
.health-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
.health-dot.ok { background: var(--success); }
.health-dot.error { background: var(--error); }
.sidebar-footer { margin-top: auto; font-size: 12px; color: var(--text-secondary); }

/* ── Main Area ───────────────────────────────────────── */
.main { display: flex; flex-direction: column; height: 100vh; }
.header {
  padding: 12px 20px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.header h1 { font-size: 16px; font-weight: 600; }
.header-controls { display: flex; gap: 8px; }

/* ── Messages ────────────────────────────────────────── */
.messages { flex: 1; overflow-y: auto; padding: 20px; }
.message {
  max-width: 80%; margin-bottom: 16px; padding: 12px 16px;
  border-radius: var(--radius); line-height: 1.6; font-size: 14px;
  white-space: pre-wrap; word-wrap: break-word;
}
.message.user {
  background: var(--accent); color: #fff; margin-left: auto;
  border-bottom-right-radius: 2px;
}
.message.assistant {
  background: var(--bg-secondary); border: 1px solid var(--border);
  border-bottom-left-radius: 2px;
}
.message.assistant code {
  background: var(--bg-tertiary); padding: 1px 5px; border-radius: 3px;
  font-family: var(--mono); font-size: 13px;
}
.message.assistant pre {
  background: var(--bg-tertiary); padding: 10px; border-radius: 4px;
  overflow-x: auto; margin: 8px 0; font-family: var(--mono); font-size: 13px;
}
.tool-indicator {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 6px 12px; margin: 4px 0; border-radius: 4px;
  font-size: 12px; font-family: var(--mono); background: var(--bg-tertiary);
}
.tool-indicator.running { border-left: 3px solid var(--warning); }
.tool-indicator.success { border-left: 3px solid var(--success); }
.tool-indicator.error { border-left: 3px solid var(--error); }
.typing-indicator { color: var(--text-secondary); font-style: italic; font-size: 13px; padding: 8px 16px; }

/* ── ask_user ────────────────────────────────────────── */
.ask-user { background: var(--accent-light); padding: 16px; border-radius: var(--radius); margin: 8px 0; }
.ask-user p { font-weight: 600; margin-bottom: 8px; }
.ask-user .options { display: flex; flex-wrap: wrap; gap: 8px; }
.ask-user .option-btn {
  padding: 6px 14px; border: 1px solid var(--accent); border-radius: var(--radius);
  background: var(--bg); color: var(--accent); cursor: pointer; font-size: 13px;
}
.ask-user .option-btn:hover { background: var(--accent); color: #fff; }

/* ── Input Area ──────────────────────────────────────── */
.input-area {
  padding: 16px 20px; border-top: 1px solid var(--border);
  display: flex; gap: 8px; align-items: flex-end;
}
.input-area textarea {
  flex: 1; padding: 10px 14px; border: 1px solid var(--border);
  border-radius: var(--radius); resize: none; font-size: 14px;
  font-family: var(--font); background: var(--bg); color: var(--text);
  min-height: 44px; max-height: 150px; line-height: 1.5;
}
.input-area textarea:focus { outline: none; border-color: var(--accent); }
.send-btn {
  padding: 10px 20px; background: var(--accent); color: #fff;
  border: none; border-radius: var(--radius); font-size: 14px;
  cursor: pointer; font-weight: 600; white-space: nowrap;
}
.send-btn:hover { opacity: 0.9; }
.send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* ── Responsive ──────────────────────────────────────── */
@media (max-width: 768px) {
  body { grid-template-columns: 1fr; }
  .sidebar { display: none; }
}
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <h2>Cowork Agent</h2>

  <div class="sidebar-section">
    <h3>Sessions</h3>
    <ul class="session-list" id="sessionList"></ul>
    <button class="btn btn-primary btn-sm" onclick="createSession()" style="margin-top:8px; width:100%;">+ New Session</button>
  </div>

  <div class="sidebar-section">
    <h3>Status</h3>
    <p style="font-size:13px;">
      <span class="health-dot" id="healthDot"></span>
      <span id="healthText">Connecting...</span>
    </p>
    <p style="font-size:12px; color:var(--text-secondary); margin-top:4px;" id="sessionInfo"></p>
  </div>

  <div class="sidebar-footer">
    <button class="btn btn-secondary btn-sm" onclick="toggleTheme()">Toggle Theme</button>
  </div>
</div>

<!-- Main -->
<div class="main">
  <div class="header">
    <h1 id="headerTitle">Cowork Agent Dashboard</h1>
    <div class="header-controls">
      <button class="btn btn-secondary btn-sm" onclick="clearChat()">Clear</button>
      <button class="btn btn-secondary btn-sm" onclick="exportChat()">Export</button>
    </div>
  </div>

  <div class="messages" id="messages">
    <div style="text-align:center; color:var(--text-secondary); padding:40px;">
      <p style="font-size:24px; margin-bottom:8px;">Welcome</p>
      <p>Create a session to start chatting with the agent.</p>
    </div>
  </div>

  <div class="input-area">
    <textarea id="input" placeholder="Type your message... (Enter to send, Shift+Enter for newline)"
              onkeydown="handleKeydown(event)" rows="1" oninput="autoResize(this)"></textarea>
    <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>Send</button>
  </div>
</div>

<script>
const API = window.location.origin;
let currentSession = null;
let ws = null;
let isStreaming = false;
let currentAssistantEl = null;

// ── Session Management ─────────────────────────────────

async function createSession() {
  const resp = await fetch(`${API}/api/sessions`, { method: "POST", headers: {"Content-Type": "application/json"}, body: "{}" });
  const data = await resp.json();
  currentSession = data.session_id;
  connectWebSocket();
  refreshSessionList();
  document.getElementById("messages").innerHTML = "";
  document.getElementById("sendBtn").disabled = false;
  document.getElementById("headerTitle").textContent = `Session ${currentSession.slice(0, 12)}`;
}

async function refreshSessionList() {
  const resp = await fetch(`${API}/api/sessions`);
  const data = await resp.json();
  const list = document.getElementById("sessionList");
  list.innerHTML = "";
  data.sessions.forEach(s => {
    const li = document.createElement("li");
    li.className = "session-item" + (s.session_id === currentSession ? " active" : "");
    li.textContent = s.session_id.slice(0, 12) + "...";
    li.title = `Messages: ${s.message_count}`;
    li.onclick = () => switchSession(s.session_id);
    list.appendChild(li);
  });
}

async function switchSession(sid) {
  currentSession = sid;
  if (ws) ws.close();
  connectWebSocket();
  refreshSessionList();
  // Load history
  const resp = await fetch(`${API}/api/sessions/${sid}/messages`);
  const data = await resp.json();
  const msgEl = document.getElementById("messages");
  msgEl.innerHTML = "";
  data.messages.forEach(m => {
    if (m.role === "user" || m.role === "assistant") {
      addMessageBubble(m.role, m.content);
    }
  });
  document.getElementById("sendBtn").disabled = false;
  document.getElementById("headerTitle").textContent = `Session ${sid.slice(0, 12)}`;
}

// ── WebSocket ──────────────────────────────────────────

function connectWebSocket() {
  if (ws) ws.close();
  const proto = location.protocol === "https:" ? "wss:" : "ws:";
  ws = new WebSocket(`${proto}//${location.host}/ws/${currentSession}`);

  ws.onopen = () => updateHealth(true);
  ws.onclose = () => updateHealth(false);
  ws.onerror = () => updateHealth(false);

  ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    switch (msg.type) {
      case "message_chunk":
        if (!currentAssistantEl) {
          currentAssistantEl = addMessageBubble("assistant", "");
        }
        currentAssistantEl.textContent += msg.chunk;
        scrollToBottom();
        break;
      case "message_end":
        currentAssistantEl = null;
        isStreaming = false;
        document.getElementById("sendBtn").disabled = false;
        break;
      case "tool_start":
        addToolIndicator(msg.tool_name, msg.tool_id, "running");
        break;
      case "tool_end":
        updateToolIndicator(msg.tool_id, msg.success ? "success" : "error", msg.duration_ms);
        break;
      case "status":
        addStatusMessage(msg.message);
        break;
      case "ask_user":
        showAskUser(msg.question_id, msg.question, msg.options);
        break;
      case "error":
        addMessageBubble("assistant", "Error: " + msg.message);
        isStreaming = false;
        document.getElementById("sendBtn").disabled = false;
        break;
    }
  };
}

// ── Chat ───────────────────────────────────────────────

function sendMessage() {
  const input = document.getElementById("input");
  const text = input.value.trim();
  if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;

  addMessageBubble("user", text);
  ws.send(JSON.stringify({ type: "message", content: text }));
  input.value = "";
  autoResize(input);
  isStreaming = true;
  document.getElementById("sendBtn").disabled = true;
}

function handleKeydown(e) {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

// ── UI Helpers ─────────────────────────────────────────

function addMessageBubble(role, content) {
  const el = document.createElement("div");
  el.className = `message ${role}`;
  el.textContent = content;
  document.getElementById("messages").appendChild(el);
  scrollToBottom();
  return el;
}

function addToolIndicator(toolName, toolId, status) {
  const el = document.createElement("div");
  el.className = `tool-indicator ${status}`;
  el.id = `tool-${toolId}`;
  el.innerHTML = `<span>${status === "running" ? "\u23F3" : "\u2705"}</span> <span>${toolName}</span> <span class="tool-duration"></span>`;
  document.getElementById("messages").appendChild(el);
  scrollToBottom();
}

function updateToolIndicator(toolId, status, durationMs) {
  const el = document.getElementById(`tool-${toolId}`);
  if (!el) return;
  el.className = `tool-indicator ${status}`;
  const icon = status === "success" ? "\u2705" : "\u274C";
  el.querySelector("span").textContent = icon;
  const dur = el.querySelector(".tool-duration");
  if (dur && durationMs) dur.textContent = `${Math.round(durationMs)}ms`;
}

function addStatusMessage(message) {
  const el = document.createElement("div");
  el.className = "typing-indicator";
  el.textContent = message;
  document.getElementById("messages").appendChild(el);
  scrollToBottom();
}

function showAskUser(qId, question, options) {
  const container = document.createElement("div");
  container.className = "ask-user";
  container.innerHTML = `<p>${escapeHtml(question)}</p><div class="options"></div>`;
  const optionsDiv = container.querySelector(".options");
  options.forEach(opt => {
    const btn = document.createElement("button");
    btn.className = "option-btn";
    btn.textContent = opt;
    btn.onclick = () => {
      ws.send(JSON.stringify({ type: "answer", question_id: qId, answer: opt }));
      container.innerHTML = `<p>${escapeHtml(question)}</p><p style="color:var(--accent);">Selected: ${escapeHtml(opt)}</p>`;
    };
    optionsDiv.appendChild(btn);
  });
  document.getElementById("messages").appendChild(container);
  scrollToBottom();
}

function scrollToBottom() {
  const el = document.getElementById("messages");
  el.scrollTop = el.scrollHeight;
}

function autoResize(el) {
  el.style.height = "auto";
  el.style.height = Math.min(el.scrollHeight, 150) + "px";
}

function updateHealth(ok) {
  const dot = document.getElementById("healthDot");
  const text = document.getElementById("healthText");
  dot.className = `health-dot ${ok ? "ok" : "error"}`;
  text.textContent = ok ? "Connected" : "Disconnected";
}

function clearChat() {
  document.getElementById("messages").innerHTML = "";
}

function exportChat() {
  const messages = document.querySelectorAll(".message");
  let md = `# Cowork Agent Chat Export\n\n`;
  messages.forEach(m => {
    const role = m.classList.contains("user") ? "User" : "Agent";
    md += `**${role}:** ${m.textContent}\n\n`;
  });
  const blob = new Blob([md], { type: "text/markdown" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "chat-export.md";
  a.click();
}

function toggleTheme() {
  const html = document.documentElement;
  html.dataset.theme = html.dataset.theme === "dark" ? "" : "dark";
}

function escapeHtml(s) {
  const div = document.createElement("div");
  div.textContent = s;
  return div.innerHTML;
}

// ── Init ───────────────────────────────────────────────

(async () => {
  try {
    const resp = await fetch(`${API}/api/health`);
    if (resp.ok) updateHealth(true);
  } catch { updateHealth(false); }
  refreshSessionList();
})();
</script>
</body>
</html>
